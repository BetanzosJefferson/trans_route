<!DOCTYPE html>
<html>
<head>
    <title>Test API Calls</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; padding: 20px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
    </style>
</head>
<body>
    <h1>üîç Test API Calls - Nueva Reserva</h1>
    <button onclick="testOrigins()">TEST 1: Cargar Or√≠genes</button>
    <button onclick="testBackendHealth()">TEST 2: Backend Health</button>
    <button onclick="clearCache()">Limpiar Cache</button>
    <div id="results"></div>

    <script>
        const API_URL = 'http://localhost:3001/api/v1';
        const COMPANY_ID = '11111111-1111-1111-1111-111111111111';
        
        function log(message, isError = false, isSuccess = false) {
            const div = document.createElement('div');
            div.className = 'result ' + (isError ? 'error' : isSuccess ? 'success' : '');
            div.innerHTML = '<strong>' + new Date().toLocaleTimeString() + '</strong>: ' + message;
            document.getElementById('results').appendChild(div);
        }
        
        async function testBackendHealth() {
            log('Probando si el backend est√° corriendo...');
            try {
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    log('‚úÖ Backend est√° corriendo en puerto 3001', false, true);
                } else {
                    log(`‚ö†Ô∏è Backend respondi√≥ con status: ${response.status}`);
                }
            } catch (error) {
                log('‚ùå Error conectando al backend: ' + error.message, true);
            }
        }
        
        async function testOrigins() {
            log('Cargando or√≠genes disponibles...');
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const url = `${API_URL}/reservations/origins?company_id=${COMPANY_ID}&date_from=${today.toISOString()}&date_to=${tomorrow.toISOString()}`;
            
            log(`URL: ${url.substring(0, 100)}...`);
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // NO CACHE
                    cache: 'no-store'
                });
                
                log(`Status: ${response.status} ${response.statusText}`);
                
                if (response.status === 401) {
                    log('‚ö†Ô∏è Endpoint requiere autenticaci√≥n (normal en producci√≥n)');
                    log('üí° Los datos S√ç est√°n en el backend, verifica el frontend');
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ √âXITO: Recibidos ${data.length} or√≠genes`, false, true);
                    
                    if (data.length > 0) {
                        log('<strong>Or√≠genes recibidos:</strong>');
                        data.forEach((item, i) => {
                            log(`${i + 1}. ${item.label} - ${item.location}`);
                        });
                        
                        if (data.length === 2) {
                            log('‚ö†Ô∏è PROBLEMA: Solo recibi√≥ 2 or√≠genes (main trips)', true);
                            log('Deber√≠a recibir 6 or√≠genes (con intermedios)');
                        } else if (data.length === 6) {
                            log('‚úÖ CORRECTO: Recibi√≥ 6 or√≠genes (incluye intermedios)', false, true);
                        }
                    } else {
                        log('‚ö†Ô∏è No hay or√≠genes disponibles');
                    }
                } else {
                    log(`‚ùå Error: ${response.status}`, true);
                    const text = await response.text();
                    log(text);
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message, true);
                log('Verifica que el backend est√© corriendo en puerto 3001');
            }
        }
        
        function clearCache() {
            log('Limpiando cache del navegador...');
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                    log('‚úÖ Cache limpiado', false, true);
                });
            }
            log('üí° Ahora presiona Cmd+Shift+R (Mac) o Ctrl+Shift+R (Win) para recargar');
        }
        
        // Auto-test al cargar
        window.onload = () => {
            log('üöÄ Pruebas iniciadas autom√°ticamente');
            testBackendHealth();
            setTimeout(() => testOrigins(), 1000);
        };
    </script>
</body>
</html>

